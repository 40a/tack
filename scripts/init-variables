#!/bin/bash -e

function usage {
  echo "USAGE: $0 <aws-region> <core-os-channel> <coreos-vm-type> <aws-key-name> <internal-tld> <cluster-name> <cidr-allow-ssh> <k8s-service-ip-range> <k8s-service-ip> <k8s-dns-ip>"
  echo "  example: $0 us-west-1 stable hvm k8s-testing testing.k8s testing 0.0.0.0/0 10.3.0.0/24 10.3.0.1 10.3.0.10"

  exit 1
}

if [[ $# -ne 10 ]]; then
  usage
fi

AWS_REGION="$1"
COREOS_CHANNEL="$2"
COREOS_VM_TYPE="$3"
AWS_EC2_KEY_NAME="$4"
INTERNAL_TLD="$5"
CLUSTER_NAME="$6"
CIDR_ALLOW_SSH="$7"
K8S_SERVICE_IP_RANGE="$8"
K8S_SERVICE_IP="$9"
K8S_DNS_IP="${10}"

COREOS_AMI_ID=`curl -s \
  $(printf "http://%s.release.core-os.net/amd64-usr/current/coreos_production_ami_%s_%s.txt" \
    $COREOS_CHANNEL $COREOS_VM_TYPE $AWS_REGION)`

AWS_ACCOUNT_ID=`aws iam get-user --output json \
	| awk '/arn:aws:/{print $2}' \
	| grep -Eo '[[:digit:]]{12}'`

AWS_REGION_AZS=`aws ec2 describe-availability-zones --region ${AWS_REGION} --output json \
  | jq --raw-output '.AvailabilityZones | map(.ZoneName) | .[]' \
  | xargs \
  | sed -e 's/ /,/g'`


cat <<EOF > terraform.tfvars
# Generated by scripts/init-variables.sh
aws.account-id = "${AWS_ACCOUNT_ID}"
aws.azs = "${AWS_REGION_AZS}"
aws.key-name = "${AWS_EC2_KEY_NAME}"
aws.region = "${AWS_REGION}"
cidr.allow-ssh = "${CIDR_ALLOW_SSH}"
coreos-aws.ami = "${COREOS_AMI_ID}"
coreos-aws.channel = "${COREOS_CHANNEL}"
coreos-aws.type = "${COREOS_VM_TYPE}"
internal-tld = "${INTERNAL_TLD}"
name = "${CLUSTER_NAME}"
s3-bucket = "${AWS_ACCOUNT_ID}-${CLUSTER_NAME}-${AWS_REGION}"
service-ip-range = "${K8S_SERVICE_IP_RANGE}"
k8s-service-ip = "${K8S_SERVICE_IP}"
dns-service-ip =" ${K8S_DNS_IP}"
EOF

cat terraform.tfvars
