#!/bin/bash -e

function usage {
    echo "USAGE: $0 <aws-region> <core-os-channel> <coreos-vm-type>"
    echo "  example: $0 us-west-1 stable hvm"
}

if [ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ]; then
    usage
    exit 1
fi

AWS_REGION="$1"
COREOS_CHANNEL="$2"
COREOS_VM_TYPE="$3"

COREOS_AMI_ID=`curl -s \
  $(printf "http://%s.release.core-os.net/amd64-usr/current/coreos_production_ami_%s_%s.txt" \
    $COREOS_CHANNEL $COREOS_VM_TYPE $AWS_REGION)`

AWS_ACCOUNT_ID=`aws iam get-user \
	| awk '/arn:aws:/{print $2}' \
	| grep -Eo '[[:digit:]]{12}'`

AWS_REGION_AZS=`aws ec2 describe-availability-zones --region ${AWS_REGION} \
  | jq --raw-output '.AvailabilityZones | map(.ZoneName) | .[]' \
  | xargs \
  | sed -e 's/ /,/g'`

cat <<EOF
# Generated by scripts/generate-variables.sh
variable "aws" {
  default = {
    account-id = "${AWS_ACCOUNT_ID}"
    azs = "${AWS_REGION_AZS}"
    region = "${AWS_REGION}"
  }
}
variable "coreos-aws" {
  default = {
    ami = "${COREOS_AMI_ID}"
    channel = "${COREOS_CHANNEL}"
    type = "${COREOS_VM_TYPE}"
  }
}
EOF
